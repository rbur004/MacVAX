#include "types.r"type 'VSIM' as 'STR ';#include "systypes.r"resource 'VSIM' (0,"Version") {	"3.36  © 1988, 89, 90, 91, 92, 93, 95 Rob Burrowes"};resource 'vers' (128) {	0x3,	0x36,	release,	0x0,	verUS,	"© ",	"3.36"	"© 1988, 89, 90, 91, 92, 93, 95 Rob Burrowes"};resource 'SIZE' (-1) {	reserved,	acceptSuspendResumeEvents,	reserved,	cannotBackground,	MultiFinderAware, 		/*doesActivateOnFGSwitch*/	backgroundAndForeground,	dontGetFrontClicks,	ignoreChildDiedEvents, 	/*ignoreAppDiedEvents*/	is32BitCompatible,	isHighLevelEventAware,	onlyLocalHLEvents,	notStationeryAware,	dontUseTextEditServices,	reserved,	reserved,	reserved,	800 * 1024,	800 * 1024};/* 2.32 * 		Added Clock interval timer * * 2.33 * 		Added XFC call 28: MAC_TIME. * * 2.34 * 		Fix: Forgot to clear interrupt bit in SISR on clock interrupt *		Shifted clearing of console SISR interrupt bit to service_interrupt() *		in vax.c from console_interupt() in iow.c. *		Shifted setting of CLOCK_INT_BIT in SISR to clock_overflow() and *		removed set_clock_interupt() (both in clock.c). *		replaced  set_clock_interupt() call with an inline setting of CLOCK_INT_BIT  *		in SISR in vax.c mtpr(), case ICCS. *		Changed clock tick time to 1 microsecond per instruction * *	2.35 *		Added the display of internal processor registers in the register window. *		They are non editable and always in hex * * 2.36 *		Added '~' (1's compliment) and '-' (2's compliment) in reg window * 2.37 *		Added Qued to the transfer menu. *		Altered transfers so they use str resources to get paths. *		Added find file option if can't find appl to launch. * 2.38 *		Shifted res id of cdef from 2 to 128 to avoid conflicts *		with system cdef resources. altered controldef.c to accept *		32 bit messages calcThumbRgn and calcCntlRgn. *		Added size resource. Added suspend/resume event processing *2.39 *		Major Hacks here. Now using MPW3.2 and the gc compiler. This is *		because the 2.2 compiler did not produce 32bit clean code.  *		Removed vertical retrace task for console interrupts. Now use *		Random() to set number of instructions to wait before interrupt. *		Removed comp type for quads and replaced with struct { long a, b }; *		... *2.40  *		Removed vscb, vpcbb and VSCBB. Introduced virtual() which returns *		a virtual address given the physical address. To help testing one *		can now give gotod a physical address by using p0x... and a virtual *		address by using v0x.... This May be moved to a check box later. *		Fixed goto address in stack or system space bug introduced in 2.39. *		Removed zerocdlines(), zerosklines() and zerosyslines().  *		Altered cdlines(), sklines() and syslines() to use IPR registers to  *		determine the number of lines in the hex and dec windows.  *		Added cdlines(), sklines() and syslines() calls to mtpr() to catch *		user changes to the pagetables. *		Removed alloc_sys_space() and alloc_p1_space() from freeallmem() *		and put them in run_reset(). Added Boot menu option and boot() to *		docmds.c. freeallmem() now sets up more IPR's default values. *		When no program is present MACVAX is left in Physical mem mode. *		Started adding code for 11/750 CMI physical mem i/o space, Unibus *		maps, memory controller etc. *2.41	Fixed bug introduced in 2.40 which incremented SLR and P0LR too soon. *		Applied Physical_Address_Mask  to all physical addresses. *2.42  Altered a.out to allow OMAGIC files to be opened. *		Altered default size to be 700K *		Made no string space message display size wanted. *		Fixed the display of memory usage. Left else out of if(IPR(MME... *		Added insque() and remque() *		Added AST traps. *		Added lots more IPR's *2.43  Added Polyf, bbcci, bbssi, adawi *		Altered default size to be 600K *		removed snarf() and used vax_fetchx() instead. *		speed up fetches and puts of words,longs,quads etc *		by checking for alignment. *		Added oct fetch and put. *		Altered a few rom calls to use pascal rather than c args. *		Added load binary menu for loading VMB.EXE (experimental only). *2.44	Added auto scroll to iow. *2.45  Fixed bug in fetch and put w,l,q functions introduced in 2.43 *		Fixed bug in virtual() which gave wrong results for P1 space. *		Added better error messages in vax.c for exceptions,  *		interrupts etc. (still needs work). *		Added checks on validity of POBR and P1BR in ldpctx() in vax.c. *2.46  Added PageDown (working), PageUp and InstructionUp (not Working) *		Buttons to the Button array in Prog Window. *		Added emul() to vax.c. *		Change click in prog window to highlight address clicked on rather *		Than move the PC to that address. Now Option Click moves PC. *		Added Display of watch points in Progw. The address field is boxed  *		if any byte in the instruction has a watch point set. *		Fixed C flag condition in subwc. Altered condition that set C flag *		in adds to a simpler one. *		Partly added is open_named_mac_file(). At the moment the pathname is *		ignored and the file is looked for in the current directory. This  *		will be XFC OPEN_NAMED_FILE (29).  *2.47  Changed progw display. Addresses to the left , labels and code mixed *		on the right, Finger moved with labels.  *		Changed Opt Click in progw so selection does not move with PC. *		Added cmd click in code (not functional). Will allow a click on a branch *		instruction to change the display to the address branched to. *		Removed the flicker from the io window in step step and step modes. *		Stopped musical windows on startup if code file openned with macvax. *2.48  Added comments on lines with reserved addressing mode faults. *		Added comment for writing to an imediate value. *		Added opt,shift click to display comment in an alert. *		Added cmd click to draw line between a branch and the destination. *		Added cmd,shift click to goto the destination of a branch. *		Added cmd opt click to go back from previous cmd,shift click goto. *		Altered findsym to return data labels as well as code labels. *		Added call to fix registers up on exceptions (does nothing though) *		Fiddled with execute(). No functional difference. *2.49	Added sysw. displays PCB and Page tables. *		Fixed refresh of windows on a cancel of an open. *		Added checks for nil function pointers in window.c. *2.50  Altered file_open() to only close existing file if mopen() succeeds. *		Now display xfc as xfc not sys. *2.51  Fixed ffc and ffs instructions. Both had >> when they wanted >>= *2.52	Fixed the remque instruction so the destination address could  *		be a register ( altered verify_address() ). *3.00	 *		Added extensions for macvax based operating system. *			Altered to allow for multiple symbol tables. *			Added internal processor registers for mac to vax comms. *				MVCR  0x29	 MacVAX Command register  *				MVCS  0x30	 MACVAX Command Status Register  *				MVPID 0x31	 MACVAX Process descriptor for symbol table info  *				MVMEM 0x32	 MACVAX Available physical memory (Read only)  *			Added vector for mac to vax comms interrupts. *				V_MACVAX ((unsigned long)0xE0)	MacVAC to VAX system interrupts *			Interrupts at level *				MACVAX_INTERRUPT_LEVEL	0x17		IPL 23 *			Added system only xfc's *				A system is running and accepts responsibility for everything  *				SYSTEM						128   *				Same as selecting Boot for File menu *				REBOOT						129  *				Create a symbol table for this file and return a descriptor *				File descriptor in R0. Returns Process descriptor in R1 *				CREATE_USER_SYMBOL_TABLE 	130 *				Create a symbol table for this file and attach it to S space *				File descriptor in R0. Returns Process descriptor in R1. *				CREATE_SYS_SYMBOL_TABLE		131 *				Tells MACVAX to forget the symbol table info for this prog *				Process descriptor in R0. Returns result code in R1. *				FREE_SYMBOL_TABLE			132 *				Tells MACVAX to use the symbol table info for P0 and P1 symbols *				Process descriptor in R0. Returns result code in R1. *				USE_USER_SYMBOL_TABLE		133	 *				Returns the name and vrefnum of a process. *				struct is a word for the volume reference number *				followed by the filename as a pascal string *				R1 -> Destination for filename struct *				R0 -> Process descriptor of open file *				GET_FILENAME_PD				134 *			Added user XFC's *				takes a filename struct pointer in R1 *				returns the fd in R0 *				OPEN_NAMED_FILE	29 *				R0 -> filedescriptor of open file *				R1 -> Destination for filename struct *				struct is a word for the volume reference number *				followed by the filename as a pascal string *				GET_FILENAME	30 *				returns 0 if it suceeded -1 if failed in R0 *				Takes address to write VRefNum and Filename in R1 *				FIND_FILE		31 *				Takes a pascal string pointer in R1 and *				returns the mac directory id (vrefnum) in R0 *				GET_DIR_ID		32 *				returns the applications mac directory id (vrefnum) in R0			 *				GET_ADIR_ID		33	 *				returns the current mac directory id (vrefnum) in R0 *				GET_CDIR_ID		34	 *			Altered load and save pctx instruction to load and save symbol table  *			pointers (stored in IPR(MVPID)). *		Added machine check registers for indicating bus errors. Actualy catch read *		and write to bad locations. I think a VAX only catches reads. *		Fixed the memory fault calls to push the correct fault description.(I think) *		Fixed Watch point bug for stack and system space in dec and hex windows. *		Added save stop and exceptions to physw and sysw. *		Reordered Functions in memory.c. *		Shifted watch point detection to the fetch and put instructions. *		Added watch point detection to the fetchlir and putlir functions. *		The above fixes the bug (not detecting watch points properly), which *		was introduced with the memory fetch speedups. *		Shifted exception handling code out of vax.c into new exception.c *		Renamed setup.c to symbol_tab.c and added multiple symbol tab code. *		created process.c to handle a single macvax process. *		Added "system label" check box to gotod as we can now have  *		system and P0 symbol tables. *		created macdev.c for handling mac to vax interrupts. *		The menu's were rearranged. *		Menus now remain active while a process is running. This is to allow *		users to interact with a running system. *		Increased the number of open files allowed. *		Now close the code file we are running as soon as it is read in.  *		We now  reopen it on a reset, but do not reread the symbol table as before. *		We also don't clear the watch points on a reset but only clear them with the *		new "Clear all Watch Points" menu item. *		Who knows what else? *3.01	Added AOUT as a file type displayed in user xfc's forfind_mac_file and mopen's. *3.02	Now Allow any type as a file type displayed in user xfc's forfind_mac_file and mopen's. *3.03  Fix watch point display in prog window (blatted by 3.00 fixes). *		Fixed binary search algorithm in printlabel(). Had wrong end condition. *		Fixed findsym(). Had left off last return statement (catches case of null *st). *		Fix findsymbyname(). Forgot to () ||'s in if statement. *		Fixed reset so it resets cleanly if started using "Load Boot Image". *		Removed 'p' and 'v' prefixes in gotod and added Virtual and Physical Radio buttons. *		Changed Load Binary Image so it displayed all types of files. *		Added SCBB to writable IPR's *3.04	Fixed bug in mtpr SCBB. *		Stopped setting of virtual radio button if IPR(MME) != 1 *3.05	Fixed mtpr KSP when IS == 1 *		Added seek(R0,0,0) to CREATE_USER_SYMBOL_TABLE and CREATE_SYS_SYMBOL_TABLE xfc's. *		Added saw_watch_point = 0 before execute in run, run_step and run_step_step. *3.06	Fixed mread. was only reading first 256 bytes. *		renumbered MVCS, MVPID, MVMEM IP's from 0x30 to 0x2A up. *		Fixed updates for sysw and memory windows when IPR(MME) is altered. *3.07	fixed scroll back a line in sysw. *		Changed drawing of line between sys and process symbols in lmemw. *		Removed %% being printed in iow when booting. *		altered virtual() in memory.c to pass over invalid pages. *		fixed trucation of labels in lmemw. *		fixed free_all_symboltable(). Had a ; after the for loop. *		Added save and restore of saw_watch_point in all window update code. *		Worked around a compiler bug with unions where members have the same name as a type. *		This should have fixed problems with watchpoints. *		Added option to stop on read or on write to a watch point. *		added clear and set range of watch point funcs in memory.c *		Added xfcs to call clear and set watch point funcs. *3.08	fixed fetchv and putv so they access the least number of bytes needed to complete. *		Had access cotrol violations when fetching too many bytes across pages. *		Fixed reset_current_proc(). Forgot to asign new fd to currentproc (amazed it worked). *		Hacked away at clear_io_window() to restore scoll bars to the top . *3.09	Fixed BLBC BLBS (jumped to wrong operand). *3.10	Fixed ret instruction. If the stack was not aligned to a long word the SP was  *		screwed up (gcc's bit fields default to signed not unsigned as was the case in the *		mpw 2.0 cc). *3.11	Removed some uneeded GetPort and SavePorts in regw, progw, lmem.c *3.12	Started hacking in a control to switch the prog window view between *		processes. At the moment the cdef is finished but changes need to be  *		made to the way the progw.c and memory.c work. *		Also changed to rel 14 of gcc 1.37 for MPW which uses 3.2 libs. *		Changed cut & paste to check for iow being in front. *3.13  Lost source to this version and can't remember what I changed. *3.14  In File Menu Changed "Send Output To?" to "Save I/O" and added  *		code for this in iow.c (This was in 3.13). Included macio.c *		and aprintf.c in mstdio.o library splitting macio.c into  *		macio and wprintf (aprintf and wprintf now use stdargs.h).  *		Made changes to "Symbol_Table_Type". Added   *		name and vrefnum fields and changed the fsym to *fsym. *3.15	GC screws up "extended x[] = { ... }" had to extract flt_imm[64] *		from execute.h and place it in its own file flt_imm.c which we *		compile with MPW C. *3.16  Quick hack to allow progw, hexw, decw and memlw code to ignore *		the virtual memory protection bits in page tables when displaying *		memory. Added a menu item which toggles between *		"Use Page Protection" and "Ignore Page Protection" in the options *		menu. *3.17	Fixed a bug in memory by label window. dumpsyms and setsym used *		a different algorithm to calculate the index into the extra *		symbol table information. dumpsyms incremented the index (i) only *		for symbols in BSS or DATA section, setsym incremented it for *		all symbols. Arbitrarily used the algorithm from dumpsyms. *3.18  Changed the probew and prober instructions so they stopped fetching  *		operand[2] and just used operand[2] as the address. *3.19	Worked around a gc compiler error that was causing the display of *		quad and oct words to bite the bag. gC is unable to cope with *		returned values passed on to other procedures directly (eg temporaries) *		if they are longer than a word. eg printquad(vax_fetchq(dot)). *		Fixed by assigning temporary value. printquad(temp_quad = vax_fetchq(dot)) *		NB: This problem may occur elsewhere in macvax, it has been fixed only *		for quads and longs. *3.20	Started hacking pieces of Shaun's MacVAX II into Rob's version. *		Put translation of xfc numbers into symbols into Rob's version. *		This is a wee bit of a hack because it relies on the internal *		mapping of numbers to names being the same as what the assembler thinks *		they are. Shaun only does the translation *		of xfc parameters if they are short literals. eg xfc #0 to xfc #63 yet *		internal xfcs are >128. Fixed for byte sized immediate mode so will do *		translation up to 256. *3.21	Reverse scrolling. *		Loaded in a bit_map from which maps addresses to instruction starts. *		Altered Symbol_Table_Type so that it included a bit_map field. *		Modified free_symboltable so that it deallocates bit_map. *		Altered progw.c so that backwards scrolling looked up the previous *		instruction in the bit map. (or nlines worth of instrs for page up) *		Note that: Old systems that used the linker did not preserve the bit map. *			Programs compiled on versions of As prior to As1.41 that used .origin *			have an incorrect bit map. *			In either case reverse scrolling is not going to work. * *		Read in version number and origin number from AOUT if they exist (and *		they do on As1.41 and later) * *		It is assumed that the program will be loaded into the same place as *		.origin specifies otherwise silly things will happen. *		Backwards scrolling relies heavily on the fact that current_process (eg *		the process executing) is the currently viewed one as it gets interesting *		information about the process from the current_process record. *		If the viewed address is greater than 0x80000000 then the system process *		is used as the current record. * *		Fixed bug in forward scrolling. for printins to operate correctly *		exceptions must be off, the simulator stopped and display mode set correctly. *		Surrounded all calls to printins by save,set and restore of these variables. *		 *3.22	Fixed the highlighting of the program window control pageup and pagedown *		buttons. (window.c page scroll functions changed for these buttons  *		and in docmds.c event loop the pageup and down button where seperated  *		from the scroll bar ones). * *		Added a test to ensure scrolling stops when the mouse moves *		away from the buttons and continues when the mouse moves back over the *		buttons (while the button still down). (window.c scroll fuctions) * *		Added scroll back even if instruction bitmap is not present. * *3.23  Changed progw.c, progw_scroll(). Test for "virtual memory on" needed to be  *		in same if statement as the "progWindow.mbase >= S_SPACE" test. Not a  *		separate test. R.B. *		 *		Changed guess_last_ins() to o return the address of the previous byte if all *		attempts at guessing the last instruction fail. * *		Added wdiscard after printing a label in guess_last_ins() and shifted the *		wdiscard for for the printins() call.  *		 *		Note: Scroll back a page should check for instructions resulting in  *		multiple line output. *3.24  Work under way, *		on page up. label probs are fixed.  *		split INS_START(...) define into INS_START(..) and IN_BITMAP(...). *		.aligns still causing probs though. AS doesn't generate bitmap entries for *		all the halts put in to align the next instruction. *3.25	Recompiled with MPW C and New Libraries (25/3/95). *		Was bombing when running on a 68040 running System 7.5. *3.26	Had reversed TRAPS and FAULTS in arithmetic_fault(). *		Filled in body of Function fix_registers() for FAULTS. *3.27	Adding a stack window code. This increased the size of the  *		process control blocks by 4 longs to save the framepointers of each stack. *		Fixed (hopefully) the fix_register code so that it didn't continue beyond *		the PC if the fault occured in an instruction decode. Also turn exceptions *		off when doing this processing. *3.28	Added a DUP_USER_SYMBOL_TABLE xfc to allow forking processes to share *		a common symbol table yet have a unique process id for macvax. *3.29	Fixed duplicate_symbol_table() so that it now increments a ref counter *		so that removing duplicate entries doesn't remove the original. *		Added an auto button to controldef 2 and made both controldef 2 & 3  *		remain visible when the window is in the background. still need to add *		code to action def 2.  *		Saved the resource for stack window position. *3.30	Added screen refresh after xfc calls which put dialog boxes on top of  *		the screen. *		Added erase window call when a IPR(XSP) is 0. *		Added PSL High Word display in regw. *		Saving the PCBB in MACVAX process_table[] when doing a svpctx(). We can *		then use this info to switch the displays between processes virtual address *		spaces. Will add functions to fix use this in later versions. *		Having problems with scrolling when only part of a line is cut by the *		bottom of the window. Solved it by only allowing windows to be multiples *		of lines in height (ie. a hack). * *3.31	Added the code to switch the display between macvax processes. *		This saves the current processes context internally and loads *		the new processes details from its PCB. The running processes *		details are retored when the program runs and swapped out when it  *		stops. Any register or memory changes made via the MacVAX interface, *		effect the displayed processes saved registers and memory. *		Added highlighting of lines clicked on in stackw *		Cmd Click on a Frames "Condition Handler" or "Saved PC" will  *		shift the Program Window Origin to that address. *		Cmd Click on a Frames "Saved AP" or "Saved FP" will highlight the  *		address if it is on the screen or shift the window origin to that *		address if it is not on the screen. *		Up and down arrows change selected line + or -. *		Added a Scroll bar to the register window. *		Fixed bug in click_progw(). Had no always called printlabel(); * *3.32	FIX BUG: AST mask was incorrect in save_display_process_ctx(); * *3.33	Fixed auto button on prog window control to correctly set the current *		process. *		Added xfc's SYSW_TO_FRONT STACKW_TO_FRONT SYSW_CLOSE STACKW_CLOSE * *3.34	Added code to allow switching display between processes when running. * *3.35	Added cvtrfl to instruction set. *		Changed reset_process() to reload symbol table of the process in *		case it changed while we had the file closed. *3.36  Converted to MW compilers and compiled native PPC (removed transfer menu) */