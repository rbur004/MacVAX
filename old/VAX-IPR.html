<html><head><title>Internal Processor Registers</title></head><body><IMG ALIGN=left SRC="pics/MacVAX-Icon.GIF">	<center><h1>VAX Internal Processor Registers</h1></center><br><p>These registers are accessed using the <b>mtpr</b> and <b>mfpr</b> instructions.<p><hr><!-- -------------------------------------------------------------- --><A NAME="IPR_STACK"><h3>Stack Registers</h3></A><ul><dl compact><A NAME="IPR_0"></A>	<dt><b>KSP <dd>0x0</b> Kernel Stack Pointer			(Read / Write)<A NAME="IPR_1"></A>	<dt><b>ESP <dd>0x1</b> Executive Stack Pointer			(Read / Write)<A NAME="IPR_2"></A>	<dt><b>SSP <dd>0x2</b> Supervisor Stack Pointer			(Read / Write)<A NAME="IPR_3"></A>	<dt><b>USP <dd>0x3</b> User Stack Pointer				(Read / Write)<A NAME="IPR_4"></A>	<dt><b>ISP <dd>0x4</b> Interrupt Stack Pointer			(Read / Write)		<p><IMG ALIGN=bottom SRC="pics/IPR-generic.GIF">		<p>		A <b>VAX</b> process has four stacks. The stack pointer to be used is 		determined by <b>bits 23</B> and <B>24</b>, the current mode		 bits 	(<b>CMD</b>), 	and		<b>bit 25</b>, the interrupt stack bit (<b>IS</b>), of the processor 		status 	long 	word (<b>PSL</b>). 		The <b>IS</b> bit of the <b>PSL</b> is set when the processor aborts, 		faults, 		traps or 		interrupts through a System Control Block (<b>SCB</b>) vector which has 		the 	low 2 	bits set to 01. 		The <b>CMD</b> field of 		the <b>PSL</b> is set to <strong>0</strong> on an  abort, fault, trap		 or interrupt. 		The <b>IS</b> bit of the <b>PSL</b> is cleared 		when a new <b>PSL</b> with the <b>IS</b> bit clear, is load by a 		<b>rei</b> 	instruction.		<p></dl></ul><A NAME="IPR_MEMORY"><h3>Virtual Memory Registers</h3></A><ul><dl compact><A NAME="IPR_8"></A>	<dt><b>P0BR 	<dd>0x8</b> Process Space <b>P0</b> Base Register		(Read / Write)	<p><IMG ALIGN=bottom SRC="pics/IPR-P0BR.GIF">	<p>                                                          	<b>POBR</b> holds the virtual address of the current processes 	<b>P0</b> page 	table entries. 	The address must be long aligned (the low 2 bits must be 00) and 	must be in 	system space 	( address >= 0x80000000 and address < 0xC0000000 ).<p><A NAME="IPR_9"></A>	<dt><b>P0LR 	<dd>0x9</b> Process Space <b>P0</b> Length Register	(Read / Write)	<p><IMG ALIGN=bottom SRC="pics/IPR-P0LR.GIF">	<p>                                                         	The <b>P0LR</b> contains the size of the current processes <b>P0</b> 	page table 	in long words.	<p><A NAME="IPR_A">	</A>		<dt><b>P1BR 		<dd>0xA</b> Process Space <b>P1</b> Base Register		(Read / Write)	<p><IMG ALIGN=bottom SRC="pics/IPR-P0BR.GIF">   <p>                                                        	<b>P1BR</b> holds the virtual address of the current processes 	<b>P1</b> page 	table	 entries. The 	address must be long aligned (the low 2 bits must be 00) and  must have a value 	between 0x7f80000 and 0xBF000000. This is to ensure the page table entries are 	always in system space.<p>	<A NAME="IPR_B"></A>		<dt><b>P1LR 		<dd>0xB</b> Process Space <b>P1</b> Length Register	(Read / Write)<p>	<IMG ALIGN=bottom SRC="pics/IPR-P0LR.GIF"><p>                                                      	The <b>P1LR</b> contains the number of unused page table entries 	(each <b>PTE</b> is a long word) of 	the current processes <b>P1</b> page table.<p>	<A NAME="IPR_C"></A>		<dt><b>SBR 			<dd>0xC</b> System Base Register			(Read / Write)<p>	<IMG ALIGN=bottom SRC="pics/IPR-SBR.GIF"><p>                                                        	<b>SBR</b> holds the Real address of the system page table entries. 	The address must be long aligned (the low 2 bits must be 00).<p>	<A NAME="IPR_D"></A>	<dt> <b>SLR 			<dd>0xD</b> System Length Register			(Read / Write)<p>	<IMG ALIGN=bottom SRC="pics/IPR-P0LR.GIF"><p>	The <b>SLR</b> contains the size of the System page table in long words.<p>	<A NAME="IPR_38"></A>	<dt><b>MAPEN		<dd>0x38</b> Memory Management Enable		(Read / Write)<p>	<IMG ALIGN=bottom SRC="pics/IPR-MAPEN.GIF"><p>	<ul>                                                           	<b>E</b>	= Enable bit		(Read / Write)<p>	</ul>	Setting <b>bit 0</b> of  the <b>MAPEN</b> register enables memory management. 	MacVAX sets this bit when resetting or loading a program.<p></dl></ul><A NAME="IPR_PCBB"><h3>Process Control Block</h3></A><ul><dl compact><A NAME="IPL_10"></A>	<dt><b>PCBB 			<dd>0x10</b> Process Control Block Base	(Read / Write)<p>	<IMG ALIGN=bottom SRC="pics/IPR-SBR.GIF">   <p> 	                                                             	<b>PCBB</b> holds the Physical address of  the current processes 	Process Control 	Block 	The address must be long aligned (the low 2 bits must be 00) .<p>	</dl></ul><A NAME="IPL_INTERRUPT"><h3>Interrupt Handling</h3></A><ul><dl compact><A NAME="IPL_11"></A>	<dt><b>SCBB 			<dd>0x11</b> System Control Block Base	(Read / Write)<p>	<IMG ALIGN=bottom SRC="pics/IPR-SBR.GIF">   <p>                                                             	<b>SCBB</b> holds the Physical address of  the System Control Block 	The address must be long 	aligned (the low 2 bits must be 00) . 	The System Control Block is a page of vectors for 	aborts, faults, traps, and interrupts.<p>	<A NAME="IPL_12"></A>	<dt><b>IPLR			<dd>0x12</b> Interrupt Priority Level Register	(Read / Write)<p>	<IMG ALIGN=bottom SRC="pics/IPR-IPLR.GIF">   <p> 		                                                            	The <b>IPLR</b> accesses <b>bits 20</b> to <b>16</b> of the <b>PS</b>.	<p>	<A NAME="IPL_13"></A>	<dt><b>ASTR			<dd>0x13</b> Async Trap level (Read/Write)<p>	<IMG ALIGN=bottom SRC="pics/IPR-ASTR.GIF">   <p> 	 	The <b>ASTR</b> holds the value of the most privileged access mode for which an 	<B>AST</B> is 	pending. Only bits 0 to 2 are used. The top bits are ignored on a 	write and returned 	as 0 on a read. AST’s are serviced on a <B>rei</B>	 instruction. 	The register is initialised 	at boot time to 0x4 (ie No AST pending).<p><A NAME="IPL_14"></A>	<dt><b>SIRR			<dd>0x14</b> Software Interrupt Request Register (Write Only)<p>	<IMG ALIGN=bottom SRC="pics/IPR-SIRR.GIF">   <p> 			                                                            	The <b>SIRR</b> is write only. A <listing><b>mtpr</b> src , 	#<b>SIRR</b></listing> instruction 	requests an software interrupt at 	<b>IPL</b> src. Pending interrupts are summarized in the <b>SISR</b>.<p>	<A NAME="IPL_15"></A>	<dt><b>SISR			<dd>0x15</b> Software Interrupt Summary Register	(Read / Write)<p>	<IMG ALIGN=bottom SRC="pics/IPR-SISR.GIF">   <p> 		                                                            	The <b>SISR</b> holds a summary of the pending software interrupts. 	The register is cleared at 	boot time and may be cleared by software using a 	<listing><b>mtpr</b> #0, 	#<b>SISR</b></listing>	This is normally considered a read only register. Software interrupts should be 	requested using the <b>SIRR</b> register not by setting bits in the  <b>SISR</b>	register directly.<p>	</dl></ul><A NAME="IPL_CLOCK"><h3>Clocks</h3></A><ul><dl compact><A NAME="IPL_18"></A>	<dt><B>ICCS 			<dd>0x18</B> Interval Clock Control Status Register		(Read / Write)<P>	<IMG ALIGN=bottom SRC="pics/IPR-ICCS.GIF">		<ul>                                                        	<b>E</b> = <b>ERR</b> or error bit. 	 (set by hardware, write clears)<br>	<b>I</b> = <b>INT</b> or interrupt bit. 	(set by hardware, write clears)<br> 	<b>IE</b> = <b>INT_ENB</b> or interrupt enabled bit	(read/write)<br>	<b>S</b> = <b>SGL</b> or Single increment bit 	(write only)<br> 	<b>X</b> = <b>XFR</b> or transfer bit	(write only)<br>	<b>R</b> = <b>RUN</b> 	(read/write)	</ul>	<p>	The <b>ICCS</b> is a read/write register that contains control and 	status 	information for the 	interval clock. When the <b>RUN</b> bit is <b>1</b>, the <b>ICR</b>	 register is 	incremented every 	microsecond (instruction on <b>MACVAX</b>). Writing to the <b>XFR</b>	 (transfer) 	bit will  copy the 	<b>NICR</b> to the <b>ICR</b>.  Writing to the <b>SGL</b> (single increment) 	bit 	when the <b>RUN</b> bit is zero 	will increment <b>ICR</b>.  When the <b>INT_ENB</b> (interrupt enable) bit 	is one 	an overflow of 	the <b>ICR</b> will generate an interrupt at <b>IPL 24</b>. 	The <b>INT</b> 	(interrupt) bit is set by hardware 	whenever the <b>ICR</b> overflows. It can must be cleared by the clock 	interrupt 	service 	routine by writing the the <b>INT</b> bit (ie.. writing a one to 	it clears it). 	The <b>ERR</b> (error) bit is 	set by hardware when an overflow occurs and the <b>INT</b> bit is	 already set. It 	may be 	cleared by writing a one to it.<p>	<A NAME="IPL_19"></A>	<dt><b>NICR		<dd>0x19</b> Next Interval Count Register			(Write Only)<p>	<IMG ALIGN=bottom SRC="pics/IPR-generic.GIF">		                                                             	<p>The <b>NICR</b> is a write only register that holds the clock 	count in 	microseconds to be 	loaded into the <b>ICR</b> when the <b>ICR</b> overflows (ie.. 	after an increment 	its value is zero) or 	when the <b>XFR</b> (transfer) bit of the <b>ICCS</b> is written to.	 As the 	<b>ICR</b> register is incremented, 	not decremented, the value stored in <b>NICR</b> should be set to the 	two's  	complement of 	the interval wanted.<p>	<A NAME="IPL_1A"></A>	<dt><b>ICR 			<dd>0x1A</b> Interval Count Register				(Read Only)<p>	<IMG ALIGN=bottom SRC="pics/IPR-generic.GIF">		                                                             	<p>The <B>ICR</B> is a read only register that is incremented every	microsecond on a 	VAX (every 	instruction on MACVAX) while the <B>RUN</B> bit of the <B>ICCS</B> 	is one. It can 	also be 	incremented by writing to the <B>SGL</B> (single increment)	 bit of the 	<B>ICCS</B>. It is loaded from 	the <B>NICR</B> when the <B>XFR</B> (transfer) bit of the 	<B>ICCS</B> is written 	to or when the <B>ICR</B> 	overflows (ie.. after an increment its value is zero). 	 An overflow will also set 	the <B>INT</B> 	(interrupt) bit of the <B>ICCS</B>. If the <B>INT</B> bit 	was already set the 	<B>ERR</B> (error) bit will be set to 	indicate one or more clock interrupts have been missed. If 	the <B>INT_ENB</B> 	(interrupt 	enable) bit is one, an overflow will generate an interrupt at 	<B>IPL 24</B>. <A NAME="IPL_1B"></A>	<dt><b>TODR		<dd>0x1B</b> Time of Year			(Read Only)<p>	<IMG ALIGN=bottom SRC="pics/IPR-generic.GIF">		                                                	<p>The MacVAX simulator provides a Time of Year processor register using the 	Macintosh internal clock.  The VAX clock has a resolution of 10ms. As the 	Macintosh 	clock has a resolution of 1 second, the low bits of the register will always be 0.  	<b>TODR</b> is 	accessed with <listing><b>mfpr</b> #TODR</listing>	</dl></ul><p><A NAME="IPL_CONSOLE"><h3>Console Registers</h3></A><ul><dl compact><A NAME="IPL_20"></A>	<dt><B>RXCS 		<dd>0x20</B> Receive Control Register			(Read / Write)<p>	<IMG ALIGN=bottom SRC="pics/IPR-RXCS.GIF">		<ul>                                                           		<B>D</B>	= Done bit		(Read Only)<br>		<B>IE</B>	= Interrupt enable		(Read/Write)<br>	</ul>		<p>The done bit in the <B>RXCS</B> register is read-only and is 	set by the 	keyboard handler 	whenever a key press is received.  It is initialized to <B>0</B> 	at bootstrap 	time and is cleared 	whenever <listing><B>mfpr</B> #<B>RXDB</B>, dst</listing> is executed.  	 If  the 	<B>RXCS</B> interrupt enable  bit is set by 	software, an interrupt is generated when done becomes set.  Similarly, 	if done is 	already 	set and the software sets interrupt enable , an interrupt is generated.<p>	<A NAME="IPL_21"></A>	<dt><B>RXDB		<dd>0x21</B> Receive Data Register			(Read Only)<p>	<IMG ALIGN=bottom SRC="pics/IPR-RXDB.GIF">		<ul>                                                             		<B>E</B> = Error bit		(Read Only)<p>	</ul>	The data received from the keyboard is stored in the low eight bits. 	 The error 	bit in the 	<B>RXDB</B> register is set when the received data contained an error 	such as 	overrun or loss 	of connection.  This register is read only.<p>	<A NAME="IPL_22"></A>	<dt><B>TXCS			<dd>0x22</B> Transmit Control Register		(Read / Write)<p>	<IMG ALIGN=bottom SRC="pics/IPR-TXCS.GIF">		<ul>                                                            		<B>R</B>	= Ready bit		Read Only<br> 		<B>IE</B>	= Interrupt enable bit	Read Write	</ul>	<p>At Bootstrap time (when MacVax is reset) the ready  bit is set to <B>1</B>. 	On a 	<listing><B>mtpr</B> src, #<B>TXDB</B></listing> instruction, the ready 	 bit is 	cleared.  When the output of the 	character completes the ready  bit is set back to <B>1</B>. If the 	interrupt 	enable bit is set by 	software, an interrupt is generated when the ready  bit is set. 	 If the ready  	bit is already 	set and software sets interrupt enable, an interrupt is also generated. <p>	<A NAME="IPL_23"></A>	<dt><B>TXDB		<dd>0x23</B> Transmit Data Register			(Write Only)<p>	<IMG ALIGN=bottom SRC="pics/IPR-TXDB.GIF">	                                                             	<p>Writing into the <B>TXDB</B> register will cause the character 	represented by the 	low byte to be 	drawn in the I/O window.  Writing to the <B>TXDB</B> register 	when the ready  bit 	is clear  	may cause the character currently being output to be lost.   		Note that the MacVAX simulator sends characters asynchronously to the screen.	This means that your characters may not appear instantly in the 	input/output window upon execution of a 	<listing><B>mtpr</B> src, #<B>TXDB</B></listing> Several	 instructions will be 	executed before the output is completed.</dl></ul><A NAME="IPL_MACVAX"><h3>MacVAX</h3></A>	<ul>	<dl compact><A NAME="IPL_29"></a>	<dt><b>MVCR	<dd>0x29</b> The MacVAX Command Register. 	(Read Only)<p>	<IMG ALIGN=bottom SRC="pics/IPR-generic.GIF">			<p>Commands from MacVAX to the VAX OS  running on MacVAX	are placed in this register. The VAX OS may only read this register. 	Currently The following are known commands.<p>	<ul><dl compact>			<dt><B>NULL_COMMAND</B>		<dd><B>0x0</B> Ignore the command.		<p>		<dt><B>NEW_PROCESS</B>		<dd><B>0x1</B> This is sent when the user selects the <B>Load Process</B>		 menu item.		<p>		<dt><B>KILL_PROCESS</B>		<dd><B>0x2</B> This is sent when the user selects the <B>Terminate 		Process</B> menu item.		<p>		<dt><B>RESET_PROCESS</B>		<dd><B>0x3</B> This is sent when the user selects the <B>Reset 		Process</B> menu item.		<p>		<dt><B>SHUTDOWN_SYS</B>		<dd><B>0x4</B> This is sent when the user selects the <B>Shutdown		 System</B> menu item.	</dl></ul>	<A NAME="IPL_2A"></a>	<dt><b>MVCS	<dd>0x2A </b> The MacVAX Command Status Register	(Read/Write)	<p><IMG ALIGN=bottom SRC="pics/IPR-MVCS.GIF">			<ul>		<B>E</B> = <B>ERR</B> or error bit. 	 (set by hardware, write clears)<br>			<B>I</B> = <B>INT</B> or interrupt bit.  (set by hardware, write clears)<br>		<B>IE</B> = <B>INT_ENB</B> or interrupt enabled bit	(read/write)<br>		</ul>	<p>The <B>MVCS</B> is a read/write register that contains control and 	status information for the MacVAX / System interface.  If  the <B>MVCS</B>	interrupt enable  bit is set	 by 	software, an interrupt, at <B>IPL 23</B> through vector 	<B>V_MACVAX</B>,  (<B>SCBB</B>+0xE0), is generated 	when <B>INT</B>  becomes set.	 If <B>INT</B>  is already set and the software sets the interrupt 	enable  bit,	 an interrupt is generated. The <B>Error</B>  bit is set if the <B>INT</B>  	  bit was 	 set when MacVAX put a command in the  <B>MVCR</B> (ie. on overflow). 	 The <B>INT</B>   and <B>Error</B> bits must be cleared, by the interrupt	 service routine, by writing a <B>1</B> to the bits 	with a <B>mtpr</B>	 instruction (don’t forget to set the <B>IE</B> bit as writing a <B>0</B>	 will clear 	this bit).<p><A NAME="IPL_2B"></a>	<dt><b>MVPID	<dd>0x2B </b> The MacVAX  Process ID				(Read/Write)	<p><IMG ALIGN=bottom SRC="pics/IPR-generic.GIF">		<p>The <B>MVPID</B> holds a process identifier used by MacVAX to match the	current <B>P0</B> process with its symbol table. The process	identifier is set by the VAX OS by using the <B>xfc</B>, 	<B>CREATE_SYS_SYMBOL_TABLE</B>. The OS may 			change the current process identifier by writing to the <B>MVPID</B> register 	with a <B>mtpr</B> or through the <B>xfc</B>, <B>USE_USER_SYMBOL_TABLE</B>. A 	<B>svpctx</B> will save the contents of this register in the long	following the <B>PCB</B> (offset 			of <B>PCB_PID</B> 	0x60). A <B>ldpctx</B>  will restore the contents of the 			<B>MVPID</B> from the long following the <B>PCB</B>. 	(see also <A HREF="xfc/System.html"><B>xfc</B> #<B>SYSTEM</B></A>).<p><A NAME="IPL_2C"></a>	<dt><b>MVMEM	<dd>0x2C </b> MacVAX  Available Memory				(Read Only)	<p><IMG ALIGN=bottom SRC="pics/IPR-generic.GIF">		<p>The <B>MVMEM</B> is a read only register holding the number of bytes of  	VAX Physical memory allocated by MacVAX at startup. This figure cannot be 	changed by the user.<p><A NAME="IPL_32"></a>	<dt><b>KFP 	<dd>0x32 </b> Kernel Frame Pointer			(Read Only)<A NAME="IPL_33"></a>	<dt><b>EFP	<dd>0x33 </b> Executive Frame Pointer			(Read Only)<A NAME="#IPL_34"></a>	<dt><b>SFP	<dd>0x34 </b> Supervisor Frame Pointer			(Read Only)<A NAME="IPL_35"></a>	<dt><b>UFP	<dd>0x35 </b> User Frame Pointer				(Read Only)<A NAME="IPL_36"></a>	<dt><b>IFP	<dd>0x36 </b> Interrupt Frame Pointer			(Read Only)		<p><IMG ALIGN=bottom SRC="pics/IPR-generic.GIF">		<p>		A <b>VAX</b> process has four frame pointers. A normal VAX		processor does not have these registers as they are not necessary. The 		frame pointer, (<b>FP</b>), is changed on procedure entry by a		<B>calls</B> or <B>callg</B> instruction and on procedure exit by 		a <B>ret</B> instruction.<p>				MacVAX uses these registers to help it display frames in the <b>Stack Window		</b>. They are not used for any other purpose. They are saved and restored 		on process context switches at the following offsets off of the <b>PCBB</b>:		<listing>			<B>PCB_KFP</B> 	0x64<br>			<B>PCB_EFP</B> 	0x68<br>			<B>PCB_SFP</B> 	0x6C <br>			<B>PCB_UFP</B> 	0x70<br>		</listing>		<p>	</ul>	<p><A NAME="IPL_MACHINE"><h3>Machine Check</h3></A>	<ul><A NAME="IPL_17"></a>	<dt><b>MCSR	<dd>0x17</b> Machine Check Status Register			(Read Only)	<p><IMG ALIGN=bottom SRC="pics/IPR-generic.GIF"><p>The <B>MCSR</B> provides additional information about bus errors and translation buffer errors which caused a machine check fault. As the only cause of a machine check fault on MacVAX is a bus error caused by an access to a non-existent physical memory location only <B>bit 3</B> of this register will be set. It is cleared when the bus error bit of the <B>MCESR</B> is cleared.<p><A NAME="IPL_26"></a>	<dt><b>MCESR 	<dd>0x26 </b> Machine Check Error Summary Register	(Read/Write)	<p><IMG ALIGN=bottom SRC="pics/IPR-generic.GIF"><p>The <B>MCESR</B> logs information about causes of a machine check fault. Currently the only thing that will cause a machine check fault on MacVax is a read or write to a non-existent Physical memory location. This will generate a bus error and set <B>bit 3</B> of the register. The <B>MCSR</B> register holds further details of the bus error. I believe a real VAX may only generate a bus error on a read and not on a write. Writing a <B>1</B> to the Bus Error bit clears it. It will also clear<B> bits 0</B> to <B>3</B> of the  <B>MCSR</B>.	<p></dl>                                                            </ul></body></html>